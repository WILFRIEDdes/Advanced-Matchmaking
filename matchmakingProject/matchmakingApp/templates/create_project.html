{% extends "base.html" %}
{% load static %}

{% block title %}Créer un projet{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-xl">
    <h1 class="text-2xl font-bold mb-6">Créer un nouveau projet</h1>

    <form method="post" class="space-y-6 bg-white p-8 rounded shadow-md">
        {% csrf_token %}

        <div>
            <label class="block mb-1 font-semibold" for="id_nom">Nom du projet</label>
            <input type="text" name="nom" id="id_nom" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400">
        </div>
    
        <div>
            <label class="block mb-1 font-semibold" for="id_description">Description</label>
            <textarea name="description" id="id_description" rows="4" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400"></textarea>
        </div>
    
        <div class="flex space-x-6">
            <div class="w-1/2">
                <label class="block mb-1 font-semibold" for="id_date_debut">Date de début</label>
                <input type="date" name="date_debut" id="id_date_debut" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div class="w-1/2">
                <label class="block mb-1 font-semibold" for="id_date_fin">Date de fin</label>
                <input type="date" name="date_fin" id="id_date_fin" class="w-full px-4 py-2 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
        </div>

        <div class="mt-6">
            <h2 class="text-lg font-semibold mb-2">Compétences requises</h2>
            <div id="compets-container" class="space-y-4">
            </div>
            <input type="hidden" name="total_competences" id="total_competences" value="0">
            <button type="button" id="addCompetBtn" class="mt-4 w-full sm:w-auto bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-xl disabled:bg-green-300 disabled:cursor-not-allowed disabled:opacity-60">
                Ajouter une compétence
            </button>
        </div>

        <div>
            <button type="submit" class="w-full bg-blue-600 text-white py-2 rounded-xl hover:bg-blue-700 font-semibold">
                Créer le projet
            </button>
        </div>
    </form>
</div>

<script>
    const competences = JSON.parse('{{ competences_json|escapejs }}');
    const competencesCount = competences.length;
    
    function updateCompetenceOptions() {
            const allSelects = document.querySelectorAll('select[name="competence_id"]');
            const selectedValues = Array.from(allSelects).map(s => s.value);

            allSelects.forEach(select => {
                const currentValue = select.value;
                Array.from(select.options).forEach(option => {
                    if (option.value !== currentValue && selectedValues.includes(option.value)) {
                        option.style.display = 'none';
                    } else {
                        option.style.display = '';
                    }
                });
            });
            
            const addCompetBtn = document.getElementById('addCompetBtn');
            if (selectedValues.length >= competencesCount) {
                addCompetBtn.disabled = true;
            } else {
                addCompetBtn.disabled = false;
            }
        }

        function refreshCompetenceSelects() {
            updateCompetenceOptions();

            document.querySelectorAll('select[name="competence_id"]').forEach(select => {
                select.removeEventListener('change', updateCompetenceOptions); // Évite doublon
                select.addEventListener('change', updateCompetenceOptions);
            });
        }

        document.getElementById('addCompetBtn').addEventListener('click', () => {
            const container = document.getElementById('compets-container');
            const div = document.createElement('div');
            div.classList = 'compet-group flex flex-col sm:flex-row sm:items-center gap-2';
            div.innerHTML = `
                <select name="competence_id" class="border p-2 rounded w-1/2">
                    <option disabled selected value="">-- Choisir une compétence --</option>
                    {% for c in competences %}
                        <option value="{{ c.id }}">{{ c.nom }}</option>
                    {% endfor %}
                </select>
                <select name="competence_niveau" class="border p-2 rounded w-1/2">
                    {% for niveau in niveaux_competence %}
                        <option value="{{ niveau.0 }}">{{ niveau.0 }}</option>
                    {% endfor %}
                </select>
                <button type="button" class="remove-compet text-red-600 font-bold px-3 py-1 hover:bg-red-100 rounded">✕</button>
            `;
            container.appendChild(div);
 
            refreshCompetenceSelects();
        });

        window.addEventListener('DOMContentLoaded', () => {
            refreshCompetenceSelects();
        });

        document.addEventListener('click', function (e) {
            if (e.target.classList.contains('remove-compet')) {
                e.target.parentElement.remove();
                refreshCompetenceSelects();
            }
        });
</script>


{% endblock %}